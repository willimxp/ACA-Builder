# 技术债分析报告: buildCombo.py

## 1. 文件概览
- **文件路径**: `buildCombo.py`
- **主要功能**: 负责建筑的组合逻辑，包括月台（Terrace）、重楼（Multi-floor）、平坐（Pingzuo）以及组合根节点（Combo Root）的管理。
- **代码规模**: 约 1500+ 行（属于核心逻辑模块）。

## 2. 主要技术债

### 2.1 状态管理混乱
- **问题描述**: 建筑的组合状态（是单体、组合子节点、还是组合根节点）通过 `ACA_data` 中的多个字段（`aca_type`, `combo_type`, `combo_parent`）共同维护。状态流转逻辑分散在各个函数中。
- **影响**: 极其容易产生无效状态（如一个建筑既是 Main 又是 Terrace）。调试困难，一旦状态错乱，整个组合逻辑崩溃。

### 2.2 循环依赖与递归风险
- **问题描述**: `buildCombo` 依赖 `buildFloor`，而 `buildFloor` 又可能调用 `buildCombo` 中的辅助函数。此外，楼层更新逻辑（`__updateFloorLoc`）涉及递归查找上下层，容易陷入死循环。
- **影响**: 模块间耦合度极高，难以拆分。递归逻辑如果没有严格的退出条件（目前有 `whilecount<10` 的硬编码限制），可能导致 Blender 崩溃。

### 2.3 数据同步的脆弱性
- **问题描述**: 组合建筑之间需要同步数据（如柱网、材质）。代码中充斥着大量的 `__syncData`、`__uploadData`、`__downloadCommonData` 调用。
- **影响**: 数据流向不清晰（有时向上汇总，有时向下分发）。新增一个属性时，需要在多个同步函数中手动添加字段名，容易遗漏。

### 2.4 "God Object" 倾向
- **问题描述**: 该模块试图处理所有类型的组合逻辑（月台、重楼、拼接、集成）。随着组合类型的增加，文件体积将无限膨胀。

## 3. 改进建议
1.  **状态机模式**: 引入明确的状态机（State Machine）来管理建筑的组合生命周期。
2.  **组合模式 (Composite Pattern)**: 重构为标准的组合模式，将“组合节点”和“叶子节点”统一抽象。
3.  **数据绑定优化**: 使用 Blender 的 Driver 机制或自定义的属性监听器来自动同步数据，而不是手动复制属性值。
