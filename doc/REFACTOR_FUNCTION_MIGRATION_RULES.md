# 代码重构 - 函数跨文件迁移编码规范
本规范为 [基础编码规范](./CODING_RULES.md) 的专项补充，未提及的通用规则请遵循基础规范。

## 1. 核心原则
- **完整性优先**：函数跨 `.py` 文件迁移时，必须完整保留函数的所有代码、注释、空行、命名格式，禁止 AI / 人工删减、修改任何内容（包括空格、缩进、注释标点）。
- **无侵入修改**：迁移仅改变函数的存储文件，不允许调整函数逻辑、参数、返回值、注释描述，也不允许优化代码风格（如换行、变量名缩写）。
- **可追溯性**：迁移后需保留函数的原始上下文标注，便于核对完整性。

## 2. 函数迁移操作规范

### 2.1 迁移前准备
- 确认目标文件的编码格式（需与源文件一致，如 UTF-8，无 BOM）。
- 检查源函数的完整范围：
  - 包含函数定义（`def 函数名(参数):`）的整段代码；
  - 函数内所有注释（单行 `#`、多行 `"""/'''` 注释）；
  - 函数内的空行、缩进（严格保留 4 空格 / 制表符格式，与原文件一致）；
  - 函数依赖的内部辅助变量 / 嵌套函数（若有，需一并迁移）。
- 记录源文件路径、函数名、迁移目标文件路径（如：`callbacks.py` → `data_callback.py`: `update_material`）。

### 2.2 迁移执行规则

**禁止修改的内容（AI / 人工均需遵守）**

| 类别 | 禁止操作示例 |
| :--- | :--- |
| **函数结构** | 修改参数名（如 `self, context` → `self, ctx`）、增减参数、修改返回值逻辑 |
| **注释** | 删除单行注释、简化多行注释、修改注释中的拼写 / 标点、新增注释 |
| **代码逻辑** | 优化循环 / 条件判断、删减空行、调整缩进、修改变量名 |
| **格式** | 将 4 空格缩进改为制表符、合并多行代码、拆分单行代码 |

**必须完整保留的内容**
- 函数的完整定义（从 `def` 开头到函数结束的所有行）；
- 函数内的所有注释（包括注释前的空行、注释后的换行）；
- 函数内的空行（如逻辑块之间的分隔空行）；
- 函数的装饰器（如 `@check_auto_rebuild`）；
- 函数的文档字符串（docstring），包括格式（如 reStructuredText/Google 风格）。

**允许的唯一操作**
- 仅将函数的完整代码块 “复制 → 粘贴” 到目标文件的指定位置；
- 若目标文件需导入依赖（如函数用到的 `bpy`/`const`），仅允许新增必要的导入语句（不修改函数本身）；
- 迁移后删除源文件中的该函数（仅删除函数代码块，不修改源文件其他内容）。

### 2.3 迁移后验证
- **人工核对**：对比源函数与迁移后的函数，逐行检查代码、注释、格式是否 1:1 一致；
- **执行验证**：运行目标文件，确保函数调用无语法错误、逻辑与迁移前一致；
- **记录归档**：在 `coding_rules.md` 同级目录下维护 `function_migration_log.md`，记录迁移信息：

```markdown
| 迁移时间 | 源文件路径               | 目标文件路径               | 函数名          | 验证人 | 备注       |
|----------|--------------------------|----------------------------|-----------------|--------|------------|
| 2026-02-11 | /ACA Builder/callbacks.py | /ACA Builder/data_callback.py | update_material | 张三   | 完整迁移，无修改 |
```

## 3. AI 工具使用约束

### 3.1 AI 辅助迁移的禁止项
- 禁止让 AI “优化”“简化”“重构” 迁移的函数代码 / 注释；
- 禁止让 AI 自动补全、修改函数的任何内容（包括注释中的错别字）；
- 禁止 AI 调整函数的缩进、空行、命名格式。

### 3.2 AI 辅助迁移的允许项
- 仅允许让 AI 执行 “纯文本复制粘贴”（如：“将文件 A 中第 10-50 行的函数完整复制到文件 B 的第 20 行后，不做任何修改”）；
- 允许让 AI 生成迁移日志（如根据迁移信息自动填充 `function_migration_log.md`）。

## 4. 例外场景（仅以下情况允许修改）
仅当函数迁移后出现语法错误（如导入路径错误）时，允许仅修改 “导入语句”，且需满足：
- 仅修改导入路径（如 `import callbacks` → `import data_callback`），不修改函数本身；
- 修改后在迁移日志中明确标注修改点（如：“仅修改导入语句，函数代码 / 注释未变”）。

## 5. 违规处理
- 若发现函数迁移后被修改（包括注释删减、代码逻辑调整），需立即回滚至迁移前版本；
- 重新按本规范执行迁移，并在日志中记录违规原因及整改结果。
