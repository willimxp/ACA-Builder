# build.py 技术债分析

## 1. 文件概览
- **功能**: 作为插件的核心构建模块，负责协调建筑生成的各个阶段（台基、柱网、墙体、屋顶等）。
- **代码行数**: 约 3750 行。
- **依赖**: 几乎依赖项目中所有其他 `build*.py` 模块以及 `utils`, `const`, `data` 等核心模块。

## 2. 主要技术债

### 2.1 "上帝模块" (God Module)
- **问题**: `build.py` 承担了过多的职责。它不仅是构建流程的协调者（Controller），还包含了大量的具体构建逻辑（如屋顶的具体生成细节、复杂的几何计算）。
- **影响**: 
    - 代码难以阅读和维护。
    - 修改任何一个构建步骤都可能需要修改此文件，导致冲突风险高。
    - 模块间的耦合度极高。
- **建议**: 将具体的构建逻辑进一步拆分到专门的模块中（如 `buildRoof.py` 已经存在，但 `build.py` 中可能仍残留了大量屋顶相关逻辑，或者反之，需要明确职责边界）。将 `build.py` 重构为纯粹的流程控制器（Facade 模式或 Builder 模式）。

### 2.2 复杂的条件分支与标志位
- **问题**: 代码中充斥着大量的 `if bData.use_dg:` 或 `if is_corner:` 等条件判断，导致执行路径极其复杂。
- **影响**: 单元测试极其困难，难以覆盖所有组合路径。
- **建议**: 使用策略模式（Strategy Pattern）或状态模式来处理不同的构建配置。

### 2.3 硬编码与魔术数字
- **问题**: 存在大量用于几何计算的魔术数字（如 `0.02`, `0.01` 等微调偏移量）。
- **影响**: 这些数字的含义不明确，调整模型精度或比例时容易出错。
- **建议**: 将所有几何常量提取到 `const.py` 中，并添加注释说明其物理含义。

### 2.4 缺乏错误处理
- **问题**: 在复杂的几何运算中，缺乏对异常情况（如零除、非法几何体）的捕获和处理。
- **影响**: 构建失败时可能直接报错甚至导致 Blender 崩溃，用户得不到友好的错误提示。
- **建议**: 添加 `try-except` 块，并在构建失败时回滚或提示用户具体的错误位置。

### 2.5 巨大的函数
- **问题**: 核心构建函数（如 `__buildRoof` 或 `buildBuilding`）可能长达数百行。
- **影响**: 逻辑难以跟踪，局部变量作用域过大。
- **建议**: 提取子函数（Extract Method），将复杂的步骤分解为独立的小函数。

## 3. 重构优先级
- **高**: 提取 `build.py` 中的具体构建逻辑到各子模块，使其成为轻量级的调度器。
- **中**: 清理魔术数字，规范化常量使用。
- **低**: 补充详细的文档注释。
