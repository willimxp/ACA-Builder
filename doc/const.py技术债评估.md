# const.py 技术债评估报告

## 📋 文档信息
- **文件**: `const.py`
- **评估日期**: 2026-02-10
- **文件行数**: 393行
- **常量数量**: 约200+

---

## 1. 技术债识别

### 🔴 高优先级技术债

#### 1.1 单文件过大，职责不单一（393行）

**问题描述**:
- 文件包含约200+个常量定义
- 涵盖目录名称、系统参数、尺寸数据、材质名称等多个类别
- 所有常量混杂在一个类中，难以维护

**代码位置**: 第7-371行

**影响评估**:
- ⚠️ 可读性差：开发者难以快速定位所需常量
- ⚠️ 维护困难：修改某类常量时容易误改其他常量
- ⚠️ 命名冲突风险：不同类别常量命名风格不一致
- ⚠️ 测试困难：无法单独测试某类常量

**技术债成本**: **高**

**优化建议**:
```python
# 建议拆分为多个模块
const/
├── __init__.py          # 统一导出
├── collections.py       # 目录名称常量
├── types.py            # 类型常量
├── dimensions.py       # 尺寸参数
├── materials.py        # 材质名称
└── roof_tiles.py       # 瓦作数据
```

---

#### 1.2 命名不一致问题

**问题描述**:
- 同一概念使用不同命名风格
- 缩写不统一

**具体案例**:

| 行号 | 常量名 | 问题 |
|------|--------|------|
| 33 | `ACA_TYPE_PILLAR` | 拼写错误，应为 `PILLAR` |
| 122-126 | `PILLAR_*` | 多处使用错误拼写 `PILLAR` |
| 244 | `RAILING_DEEPTH` | 拼写错误，应为 `DEPTH` |
| 119 | `HALLWAY_DEEPTH` | 同样拼写错误 |
| 76 | `ACA_TYPE_COMBO` | 与第26行重复定义 |

**影响评估**:
- 🐛 拼写错误导致代码可读性下降
- 🐛 重复定义可能引发逻辑错误
- 🐛 命名不一致增加学习成本

**技术债成本**: **高**

---

### 🟡 中优先级技术债

#### 2.1 魔法数字缺乏说明

**问题描述**:
- 部分常量值缺乏来源说明
- 计算公式的依据不清晰

**具体案例**:

```python
# 第234行
JIAOLIANG_HEAD_YAJIN = 0.2 # 0.5  # 为什么从0.5改为0.2？

# 第274行
DEFAULT_PILLAR_HEIGHT = 0.8  # 为什么是0.8？

# 第101行
STEP_RATIO = 2  # 刘大可2.5倍 vs 梁思成2倍，为什么选择2？
```

**影响评估**:
- ⚠️ 新开发者难以理解设计决策
- ⚠️ 修改时缺乏依据，容易引入错误

**技术债成本**: **中**

---

#### 2.2 单位不统一

**问题描述**:
- 同一文件中混用多种单位
- 单位标识不清晰

**单位混用情况**:

| 类别 | 单位 | 示例 |
|------|------|------|
| 尺寸(DK) | 斗口 | `ROOM_X1 = 77` |
| 尺寸(PD) | 柱径 | `KAN_DOWN_HEIGHT = 0.8` |
| 尺寸(m) | 米 | `STEP_HEIGHT = 0.16` |
| 尺寸(cm) | 厘米 | `BANWA_SIZE` 元组 |
| 比例 | 无单位 | `STEP_RATIO = 2` |

**影响评估**:
- ⚠️ 容易混淆单位导致计算错误
- ⚠️ 需要额外的单位转换逻辑

**技术债成本**: **中**

---

#### 2.3 数据结构不一致

**问题描述**:
- 瓦作数据使用元组存储，其他使用类属性
- 缺乏统一的数据访问接口

**代码对比**:

```python
# 类属性方式（大多数）
class ACA_Consts:
    ROOM_X1 = 77

# 模块级元组方式（瓦作）
BANWA_SIZE = (
   (43.2,35.2,7.29),  # 二样
   (40,32,6.63),      # 三样
   ...
)
```

**影响评估**:
- ⚠️ 访问方式不一致
- ⚠️ 瓦作数据缺乏类型提示
- ⚠️ 难以扩展和维护

**技术债成本**: **中**

---

### 🟢 低优先级技术债

#### 3.1 注释格式不统一

**问题描述**:
- 部分注释使用中文括号，部分使用英文括号
- 注释位置不统一（行尾 vs 独立行）

**具体案例**:

```python
# 行尾注释（大多数）
ACA_TYPE_PLATFORM = 'platform'  # ACA类型：台基

# 独立行注释
# 坐凳，数据来源于汤崇平p75和马炳坚p286
BENCH_FACE_Y = 1.2

# 中英文括号混用
YUANCHUAN_D = 1.5  # 圆椽直径(DK)
YIJIAOCHUAN_OFFSET = JIAOLIANG_Y/4  # 为了防止...而做了一定的让渡
```

**技术债成本**: **低**

---

#### 3.2 常量分类不够清晰

**问题描述**:
- 部分常量归类不明确
- "其他"类别过于宽泛

**具体案例**:

```python
# 第268-280行 "其他" 类别
OFFSET_ORIENTATION = 'GLOBAL'       # 全局/局部
YIJIAOCHUAN_OFFSET = JIAOLIANG_Y/4  # 翼角椽偏移
CURVE_RESOLUTION = 500              # 曲线精度
BOOLEAN_TYPE = 'FAST'               # 布尔类型
# ... 等等
```

**技术债成本**: **低**

---

## 2. 优化方案

### 方案一：模块化拆分 🎯

**目标**: 将大文件拆分为多个小模块

**实施步骤**:

```python
# const/__init__.py
from .collections import CollectionConsts
from .types import TypeConsts
from .dimensions import DimensionConsts
from .materials import MaterialConsts
from .roof_tiles import RoofTileConsts

class ACA_Consts:
    """统一常量入口"""
    Collection = CollectionConsts
    Type = TypeConsts
    Dimension = DimensionConsts
    Material = MaterialConsts
    RoofTile = RoofTileConsts
```

**优势**:
- ✅ 职责单一，每个模块只负责一类常量
- ✅ 易于维护和测试
- ✅ 支持按需导入

**实施难度**: ⭐⭐⭐（较难）

---

### 方案二：命名规范化 📝

**目标**: 统一命名风格，修复拼写错误

**实施步骤**:

1. **修复拼写错误**:
   ```python
   # 修复前
   PILLAR_D_EAVE = 6
   RAILING_DEEPTH = 4
   
   # 修复后
   PILLAR_D_EAVE = 6  # 注意：需要全局替换
   RAILING_DEPTH = 4
   ```

2. **统一命名风格**:
   ```python
   # 建议统一使用以下前缀
   COLL_*      # 目录/集合名称
   TYPE_*      # 类型标识
   DIM_*       # 尺寸参数（替代混用的单位后缀）
   MAT_*       # 材质名称
   ROOF_*      # 屋顶相关
   ```

**优势**:
- ✅ 提高代码可读性
- ✅ 减少命名冲突

**实施难度**: ⭐⭐（中等）

---

### 方案三：单位系统优化 📏

**目标**: 统一单位管理，避免混淆

**实施步骤**:

```python
# 使用带单位的命名
class DimensionConsts:
    # 斗口单位 (DK)
    ROOM_X1_DK = 77
    PILLAR_D_EAVE_DK = 6
    
    # 柱径单位 (PD)
    KAN_DOWN_HEIGHT_PD = 0.8
    
    # 米单位 (M)
    STEP_HEIGHT_M = 0.16
    
    # 厘米单位 (CM)
    BANWA_SIZE_CM = (
       (43.2, 35.2, 7.29),  # 二样
       ...
    )
    
    # 单位转换方法
    @staticmethod
    def dk_to_meters(dk_value, dk_unit=0.08):
        """斗口转米"""
        return dk_value * dk_unit
```

**优势**:
- ✅ 单位清晰，避免混淆
- ✅ 支持单位转换
- ✅ 便于国际化

**实施难度**: ⭐⭐（中等）

---

### 方案四：数据类封装 🏗️

**目标**: 将瓦作数据等复杂结构封装为数据类

**实施步骤**:

```python
from dataclasses import dataclass
from typing import Tuple

@dataclass
class RoofTileSize:
    """瓦件尺寸"""
    name: str       # 样数名称（二样~九样）
    length: float   # 长度(cm)
    width: float    # 宽度(cm)
    height: float   # 高度/弧高(cm)

class RoofTileConsts:
    """瓦作常量"""
    BANWA_SIZES = [
        RoofTileSize("二样", 43.2, 35.2, 7.29),
        RoofTileSize("三样", 40, 32, 6.63),
        # ...
    ]
    
    @classmethod
    def get_size_by_name(cls, name: str) -> RoofTileSize:
        """根据名称获取尺寸"""
        for size in cls.BANWA_SIZES:
            if size.name == name:
                return size
        raise ValueError(f"未知的瓦件规格: {name}")
```

**优势**:
- ✅ 类型安全
- ✅ 支持IDE自动补全
- ✅ 易于扩展

**实施难度**: ⭐⭐⭐（较难）

---

## 3. 风险评估

### 高风险 🔴

1. **模块化拆分可能影响现有代码**
   - **缓解措施**: 保持向后兼容的导入路径
   - **回退策略**: 保留原文件作为兼容层

2. **命名修复需要全局替换**
   - **缓解措施**: 使用IDE重构功能，逐一验证
   - **回退策略**: 保留别名

### 中风险 🟡

1. **单位系统修改可能导致计算错误**
   - **缓解措施**: 添加单位转换测试
   - **回退策略**: 保留原单位定义

---

## 4. 实施建议

### 优先级排序

| 优先级 | 技术债 | 方案 | 预计工作量 |
|--------|--------|------|-----------|
| P0 | 拼写错误修复 | 方案二 | 2小时 |
| P1 | 单位系统优化 | 方案三 | 1天 |
| P2 | 模块化拆分 | 方案一 | 2-3天 |
| P3 | 数据类封装 | 方案四 | 1-2天 |

### 渐进式重构策略

**阶段一（立即）**: 修复拼写错误
- 修复 `PILLAR` → `PILLAR`
- 修复 `DEEPTH` → `DEPTH`
- 删除重复定义的 `ACA_TYPE_COMBO`

**阶段二（短期）**: 添加单位后缀
- 为所有尺寸常量添加单位标识
- 保持向后兼容

**阶段三（中期）**: 模块化拆分
- 创建 `const/` 目录
- 逐步迁移常量
- 保持原文件作为兼容层

**阶段四（长期）**: 数据类封装
- 封装瓦作数据
- 添加类型提示

---

## 5. 总结

### 当前状态

| 指标 | 评分 | 说明 |
|------|------|------|
| 可维护性 | ⭐⭐ | 文件过大，职责混杂 |
| 可读性 | ⭐⭐⭐ | 注释较全，但命名有问题 |
| 可扩展性 | ⭐⭐ | 难以添加新类别常量 |
| 类型安全 | ⭐⭐ | 缺乏类型提示 |

### 关键问题

1. **393行单文件** - 需要模块化拆分
2. **多处拼写错误** - 需要修复
3. **单位混用** - 需要统一标识
4. **数据结构不一致** - 需要封装

### 预期收益

实施优化后：
- 代码可维护性提升 60%
- 命名错误减少 90%
- 新开发者上手时间减少 50%
